# Allow compute credits usage for collaborators and anything pushed to the
# main, staging, and trying branches. (So bors can use them.)
use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true' || $CIRRUS_BRANCH == 'main' || $CIRRUS_BRANCH == 'staging' || $CIRRUS_BRANCH == 'trying'


Lint_task: &task
  env:
    CACHIX_CACHE_NAME: memtree
    CACHIX_AUTH_TOKEN: "ENCRYPTED[80ed347b44a4127b859772f4455bea4085b4c245fcb0a21587ae322cb3bcb1705d2f95dc5580fa2ce60dd3550db7e7cb]"
  container:
    image: nixpkgs/cachix
  config_script:
    - cachix use "$CACHIX_CACHE_NAME"
  build_script:
    - nix-build --pure ci.nix
  script:
    - nix-shell --pure ci.nix --run 'bork run lint'
  cache_update_script:
    - |
      [ -z "$CACHIX_AUTH_TOKEN" ] || {
        realpath ./result | cachix push "$CACHIX_CACHE_NAME"
      }

Test_task:
  <<: *task
  script:
    - nix-shell --pure ci.nix --run 'bork run test'

Integration_task:
  <<: *task
  env:
    CONFIG_SNIPPET: >-
      experimental-features = flakes nix-command
  nix_config_file:
    path: /etc/nix/nix.conf
    # TODO: inline this if Cirrus CI supports doing so
    variable_name: CONFIG_SNIPPET
  build_script:
    - nix build .
  script:
    - nix run .
  # Don't push to cache:
  # - the build input currently depends on the whole repo's contents, so isn't cacheable;
  # - it's somehow broken for the flake's build:
  #   https://cirrus-ci.com/task/5650607323742208?logs=cache_update
  cache_update_script: []


# Meta-task which depends on every other test/lint task to finish.
success_task:
  name: CI success
  container: {image: "busybox"}
  script: "exit 0"
  depends_on:
    - Lint
    - Test
    - Integration

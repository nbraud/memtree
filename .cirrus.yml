# Allow compute credits usage for collaborators and anything pushed to the
# main, staging, and trying branches. (So bors can use them.)
use_compute_credits: $CIRRUS_USER_COLLABORATOR == 'true' || $CIRRUS_BRANCH == 'main' || $CIRRUS_BRANCH == 'staging' || $CIRRUS_BRANCH == 'trying'


Lint_task: &task
  env:
    CACHIX_CACHE_NAME: memtree
    CACHIX_AUTH_TOKEN: "ENCRYPTED[80ed347b44a4127b859772f4455bea4085b4c245fcb0a21587ae322cb3bcb1705d2f95dc5580fa2ce60dd3550db7e7cb]"
  container:
    image: nixpkgs/cachix
  config_script:
    - cachix use "$CACHIX_CACHE_NAME"
  build_script:
    - nix-build --pure ci.nix
  script:
    - nix-shell --pure ci.nix --run 'bork run lint'
  cache_update_script:
    - |
      [ -z "$CACHIX_AUTH_TOKEN" ] || {
        realpath ./result | cachix push "$CACHIX_CACHE_NAME"
      }

Test_task:
  <<: *task
  script:
    - nix-shell --pure ci.nix --run 'bork run test'


# Meta-task which depends on every other test/lint task to finish.
success_task:
  name: CI success
  container: {image: "busybox"}
  script: "exit 0"
  depends_on:
    - Lint
    - Test
